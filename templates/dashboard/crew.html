<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização e Edição do Crew</title>
    <link rel="icon" type="image/png" href="/static/images/icons/favicon.ico"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
<header class="header d-flex justify-content-between align-items-center">
    <h1>Max Grow - Dashboard</h1>
    <div class="dropdown">
        <a class="dropdown-toggle user-dropdown" href="#" role="button" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
            Olá, <span id="user-name">{{ user_name }}</span>
        </a>
        <ul class="dropdown-menu" aria-labelledby="dropdownUser">
            <li><a class="dropdown-item" href="/logout">Sair da conta</a></li>
        </ul>
    </div>
</header>
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <a href="dashboard">Página Inicial</a>
                <a href="/questionarios">Questionários</a>
                <a href="/crew_manager">Times IA</a>
                <a href="/chat">Crew Chat</a>
            </nav>


        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <br>
            <h2>{{ crew_info.name }}</h2>
            <form id="edit-crew-form" action="/editar_crew" method="POST">
                <input type="hidden" name="name_crew" value="{{ crew_info.name }}">
                <div class="mb-3">
                    <label for="quantity_agents" class="form-label">Quantidade de Agentes</label>
                    <input type="number" class="form-control" id="quantity_agents" name="quantity_agents" value="{{ crew_info.quantity_agents }}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Selecione os Agentes:</label>
                    <div id="agents-list" class="form-check">
                        {% for agent in all_agents %}
                        <div>
                            <input type="checkbox" id="agent-{{ agent.id }}" name="agents" class="form-check-input" value="{{ agent.id }}" 
                                {% if agent.id in crew_info.agents %}checked{% endif %}>
                            <label for="agent-{{ agent.id }}" class="form-check-label">{{ agent.nome }}</label>
                        </div>                        
                        {% endfor %}                    
                    </div>
                </div>
                <div class="mb-3">
                    <label for="quantity_tasks" class="form-label">Quantidade de Tarefas</label>
                    <input type="number" class="form-control" id="quantity_tasks" name="quantity_tasks" value="{{ crew_info.quantity_tasks }}" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Selecione as Tarefas:</label>
                    <div id="tasks-list" class="form-check">
                        {% for task in all_tasks %}
                        <div>
                            <input type="checkbox" id="task-{{ task.id }}" name="tasks" class="form-check-input" value="{{ task.id }}" 
                                {% if task.id in crew_info.tasks %}checked{% endif %}>
                            <label for="task-{{ task.id }}" class="form-check-label">{{ task.nome }}</label>
                        </div>
                        {% endfor %}
                    </div>                    
                </div>
                <div class="mb-3">
                    <label for="llm-crew" class="form-label">LLM para o Crew</label>
                    <select class="form-control" id="llm-crew" name="llm_crew" required>
                        <option value="" disabled>Escolha a LLM do Crew</option>
                        <option value="llama" {% if crew_info.llm == "llama" %}selected{% endif %}>Llama</option>
                        <option value="gpt_4_mini" {% if crew_info.llm == "gpt_4_mini" %}selected{% endif %}>GPT 4 Mini</option>
                        <option value="gemma" {% if crew_info.llm == "gemma" %}selected{% endif %}>Gemma</option>
                        <option value="mistral" {% if crew_info.llm == "mistral" %}selected{% endif %}>Mistral</option>
                    </select>
                </div>
                <button type="submit" id="save-crew-btn" class="btn btn-primary">Salvar alterações</button>
            </form>
        </main>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
        const agentContainer = document.getElementById('agents-list');
        const taskContainer = document.getElementById('tasks-list');
        const crewInfo = {
            agents: {{ crew_info.agents | tojson }},
            tasks: {{ crew_info.tasks | tojson }}
        };
        console.log(crewInfo);
    
        // Carregar agentes do banco de dados
        fetch('/LoadAgents')
        .then(response => response.json())
        .then(agents => {
            agents.forEach(agent => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = agent.id; // Usando o id do agente
                checkbox.id = `agent-${agent.id}`; // Usando o id para o checkbox
                
                // Verifica se o id do agente está no crew e marca o checkbox
                if (crewInfo.agents.includes(agent.id)) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.innerText = agent.name;
                
                const div = document.createElement('div');
                div.appendChild(checkbox);
                div.appendChild(label);
                agentContainer.appendChild(div);
            });
        })
        .catch(error => console.error('Erro ao carregar agentes:', error));
        

        // Carregar tarefas do banco de dados
        fetch('/LoadTasks')
        .then(response => response.json())
        .then(tasks => {
            tasks.forEach(task => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = task.id; // Usando o id da tarefa
                checkbox.id = `task-${task.id}`; // Usando o id para o checkbox
                
                // Verifica se o id da tarefa está no crew e marca o checkbox
                if (crewInfo.tasks.includes(task.id)) {
                    checkbox.checked = true;
                }
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.innerText = task.name;
                
                const div = document.createElement('div');
                div.appendChild(checkbox);
                div.appendChild(label);
                taskContainer.appendChild(div);
            });
        })
        .catch(error => console.error('Erro ao carregar tarefas:', error));
        
    });

    document.querySelector('#edit-crew-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const agents_crew = Array.from(document.querySelectorAll('#agents-list input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);

        const tasks_crew = Array.from(document.querySelectorAll('#tasks-list input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);
        
        const name_crew = document.querySelector('input[name="name_crew"]').value;
        const agent_count = document.querySelector('#quantity_agents').value;  
        const task_count = document.querySelector('#quantity_tasks').value;  
        const llm = document.querySelector('#llm-crew').value;  
    
        const data = {
            name_crew,
            agents_crew,
            tasks_crew,
            agent_count,
            task_count,
            llm
        };
        console.log(data);
    
        // Envio do formulário
        fetch('/editar_crew', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert("Erro: " + data.error);
            } else {
                alert("Crew atualizado com sucesso!");
            }
        })
        .catch(error => {
            console.error('Erro ao enviar formulário:', error);
        });
    });
    
    
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
